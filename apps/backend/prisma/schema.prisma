// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  // url moved to prisma.config.ts for Prisma 7
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  password  String
  scopes    String   @default("") // comma-separated list
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  households        HouseholdMember[]
  refreshTokens     RefreshToken[]
  createdHouseholds Household[]        @relation("HouseholdCreatedBy")
  updatedHouseholds Household[]        @relation("HouseholdUpdatedBy")
  createdStores     Store[]            @relation("StoreCreatedBy")
  updatedStores     Store[]            @relation("StoreUpdatedBy")
  createdAisles     StoreAisle[]       @relation("StoreAisleCreatedBy")
  updatedAisles     StoreAisle[]       @relation("StoreAisleUpdatedBy")
  createdSections   StoreSection[]     @relation("StoreSectionCreatedBy")
  updatedSections   StoreSection[]     @relation("StoreSectionUpdatedBy")
  createdItems      StoreItem[]        @relation("StoreItemCreatedBy")
  updatedItems      StoreItem[]        @relation("StoreItemUpdatedBy")
  createdListItems  ShoppingListItem[] @relation("ShoppingListItemCreatedBy")
  updatedListItems  ShoppingListItem[] @relation("ShoppingListItemUpdatedBy")
}

model Household {
  id          String   @id @default(uuid())
  name        String
  createdById String
  updatedById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  members   HouseholdMember[]
  stores    Store[]
  createdBy User              @relation("HouseholdCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  updatedBy User              @relation("HouseholdUpdatedBy", fields: [updatedById], references: [id], onDelete: Restrict)
}

model HouseholdMember {
  id          String   @id @default(uuid())
  householdId String
  userId      String
  role        String // "owner" | "editor" | "viewer"
  createdAt   DateTime @default(now())

  household Household @relation(fields: [householdId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([householdId, userId])
}

model AppSetting {
  key       String   @id
  value     String
  updatedAt DateTime @default(now()) @updatedAt
}

model QuantityUnit {
  id           String @id
  name         String
  abbreviation String
  sortOrder    Int
  category     String

  shoppingListItems ShoppingListItem[]
}

model Store {
  id          String   @id @default(uuid())
  householdId String
  name        String
  createdById String
  updatedById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  household         Household          @relation(fields: [householdId], references: [id], onDelete: Cascade)
  createdBy         User               @relation("StoreCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  updatedBy         User               @relation("StoreUpdatedBy", fields: [updatedById], references: [id], onDelete: Restrict)
  aisles            StoreAisle[]
  sections          StoreSection[]
  items             StoreItem[]
  shoppingListItems ShoppingListItem[]
}

model StoreAisle {
  id          String   @id @default(uuid())
  storeId     String
  name        String
  sortOrder   Int      @default(0)
  createdById String
  updatedById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  store     Store          @relation(fields: [storeId], references: [id], onDelete: Cascade)
  createdBy User           @relation("StoreAisleCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  updatedBy User           @relation("StoreAisleUpdatedBy", fields: [updatedById], references: [id], onDelete: Restrict)
  sections  StoreSection[]
  items     StoreItem[]
}

model StoreSection {
  id          String   @id @default(uuid())
  storeId     String
  aisleId     String
  name        String
  sortOrder   Int      @default(0)
  createdById String
  updatedById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  store     Store       @relation(fields: [storeId], references: [id], onDelete: Cascade)
  aisle     StoreAisle  @relation(fields: [aisleId], references: [id], onDelete: Cascade)
  createdBy User        @relation("StoreSectionCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  updatedBy User        @relation("StoreSectionUpdatedBy", fields: [updatedById], references: [id], onDelete: Restrict)
  items     StoreItem[]
}

model StoreItem {
  id          String    @id @default(uuid())
  storeId     String
  name        String
  nameNorm    String
  aisleId     String?
  sectionId   String?
  usageCount  Int       @default(0)
  lastUsedAt  DateTime?
  isHidden    Boolean   @default(false)
  isFavorite  Boolean   @default(false)
  createdById String
  updatedById String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  store             Store              @relation(fields: [storeId], references: [id], onDelete: Cascade)
  aisle             StoreAisle?        @relation(fields: [aisleId], references: [id], onDelete: SetNull)
  section           StoreSection?      @relation(fields: [sectionId], references: [id], onDelete: SetNull)
  createdBy         User               @relation("StoreItemCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  updatedBy         User               @relation("StoreItemUpdatedBy", fields: [updatedById], references: [id], onDelete: Restrict)
  shoppingListItems ShoppingListItem[]

  @@unique([storeId, nameNorm])
}

model ShoppingListItem {
  id           String    @id @default(uuid())
  storeId      String
  storeItemId  String?
  qty          Float?
  unitId       String?
  notes        String?
  isChecked    Boolean   @default(false)
  checkedAt    DateTime?
  isSample     Boolean?
  isIdea       Boolean   @default(false)
  snoozedUntil DateTime?
  createdById  String
  updatedById  String
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  store     Store         @relation(fields: [storeId], references: [id], onDelete: Cascade)
  storeItem StoreItem?    @relation(fields: [storeItemId], references: [id], onDelete: Cascade)
  unit      QuantityUnit? @relation(fields: [unitId], references: [id], onDelete: SetNull)
  createdBy User          @relation("ShoppingListItemCreatedBy", fields: [createdById], references: [id], onDelete: Restrict)
  updatedBy User          @relation("ShoppingListItemUpdatedBy", fields: [updatedById], references: [id], onDelete: Restrict)
}

model RefreshToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}
